### Gas分类

- 交易Gas
- 部署Gas



### 深入了解Gas计算

https://www.youtube.com/watch?v=idczt1ce6t4

https://www.youtube.com/watch?v=24Oa_f6P4O0

- 只读操作是需要花费Gas，但是不需要我们付费

### 清单

- 减少链上数据

  - Events
  - IPFS
  - 无状态合约
  - Merkle Proofs

- 最小化链上操作

  - 字符串
    - EVM会将字符串转化为bytes，需要开销
  - 返回存储值
    - 需要在某些功能后返回存储值，按原样返回，不进行转换，让检索数据的链外应用程序做这些工作(从数组中提取某些值等等)
  - 循环
    - 尽量使用映射代替长数组
  - 本地存储变量
  - 批处理

- 内存位置

  从最便宜的到最贵的：calldata，栈，内存和存储

  - calldata
    - 只适用于**输入参数且参数是外部函数的引用数据类型（数组，字符串 ...）**
    - calldata参数是只读的
  - 栈
    - 只对方法中定义的值类型数据有效
  - 内存
    - 存储引用类型
  - 存储

- 变量顺序

  - 插槽长度为32bytes

- 首选的数据类型

  - 使用实际占用完整存储槽的变量

- 库

  - 在智能合约中使用重复代码，最好将所有代码打包到一个库中，部署，使用import的方式指向

- 最小代理(ERC1167)

  - 如果你需要部署多个功能完全相同的合约，应该考虑使用 "最小代理"（在 ERC 1167 中定义）

    最小的代理只是一个合约，它将把所有的调用委托给一个预先定义的*实现合约*。它有一个定义好的字节码，代表最小代理合约的编译代码，你只需要把你的实现合约地址插入其中，你就可以根据需要部署最小代理的多个副本。参考ERC 1167相关文章，了解如何使用最小代理）。

    由于最小的代理字节码非常小，部署它的成本也低到不能再低，因此节省一堆**部署 Gas**。

    使用最小代理的注意事项，你应该牢记：最小代理的实现合约地址不能改变，这意味着你将不能升级他们的代码。

- 构造函数

  - **常量及不可变量（**immutable**）**：常量和不可变的状态变量在合约被部署后不能被改变。区别在于，常量必须在编译时定义，而不可变量可以在构造函数中定义。总是尽量使用常量，以便使构造函数更便宜。

- 合约大小

  - 合约的部署成本取决于几个方面，其中之一是你要部署的合约的大小（以 KB 为单位，请记住，单个合约的限制是 24KB）
  - **日志/信息**：使 revert 和 assert 提示信息尽可能的短。
  - **修改器**：修改器（modifier）代码是内联的，这意味着它会被添加在所修改的函数的开头或结尾。在使用修改器时减少合约大小的一个技巧是编写一个实现修改器逻辑的函数，然后让修改器调用该函数。这样实现修改器的代码就不会被复制，只有函数调用会被复制。这种技术只在同一修改器被多次使用时有效。
  - **函数**：在实现你的功能时，尽量少用操作码。这并不总是可能的，甚至在 Gas 方面也不那么有效，因为有些操作码比其他操作码更昂贵，你可能会节省部署 Gas，但会增加交易 Gas......

- solidity编译器优化器

  - 激活 solidity 编译器 Gas 优化器
  - 优化器试图简化复杂的表达式，从而减少代码大小和执行成本。它还对函数进行形式化或内联。函数内联是一个可能导致更大的代码的操作，但它经常被做，因为它带来更多简化（运算）的机会

