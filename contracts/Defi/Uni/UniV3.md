## Uniswap v3

### 核心设计

集中流动性，解决v2中资金利用效率不高的问题。

### 设计原理

**v2中资金使用率低的问题**

$$x * y = k$$

在v2中，流动性沿储备金曲线均匀分布，价格区间是0到正无穷，但是实际市场中价格是有限价格区间波动，意味着流动性池中的大部分资产是永远不会被触及到，导致资金利用效率过低。

假设说WETH/USDC交易对的流动性池中共有资金：9000USDC和2WETH，即WETH的价格为4500USDC，可以算出k为18000，当WETH的价格下降到4000USDC时，根据xy = 18000，y/x = 4000，可以计算出此时的USDC的资金为y' = 8485，资金使用率为(9000 - 8485) / 9000 = 5.72%。也就是说在价格有较大波动的时候，资金使用率也没有超过10%，这个问题对于稳定币池子来说会更严重。

**集中流动性**

流动性提供者可以将其提供的流动性限制在一定的价格区间内来集中其流动性。不仅能提升资金利用率，同时使得这个价格区间里有更高的交易深度，即更大的流动性。(资金使用率可以提升到5成以上，甚至是更高)

### 实现

**Tick和Position**

价格区间Position由离散的ticks来划定，也就是流动提供者可以在任意两个ticks之间的范围内提供流动性。由于不同币种的价值相差很大，因此使用相对的百分比来移动价格区间，在Uni v3中把价格基准点设置为0.01%，这样每一个价格都是1.0001的整数指数，以i为索引指数，则在每个tick的价格p可以表示为：$$p(i) = 1.0001^i$$，$$i = \lfloor{log_{\sqrt{1.0001}}\sqrt{p}}\rfloor$$，使用索引指数i表示价格区间比较方便，比如[100, 101]就可以表示为1.001的100次方和101次方之间的价格区间，相较于实际价格[1.0100496621, 1.0101506671]表示上会简单很多。

这样就把价格做了离散化处理，每一个position对应两个tick，tick_lower和tick_upper，而且不同的position可以共用同一个tick，只有被选做某个position的价格边界的tick才会被实例化，同时在tick上记录流动性的变化。

